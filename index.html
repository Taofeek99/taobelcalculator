<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Taobel Calculator</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#002b55">
  <style>
    :root{
      --bg1:#002b55; --bg2:#005f99;
      --card: rgba(255,255,255,0.04);
      --accent: #00c6ff;
      --text: #e6f7ff;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;}
    body{
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .app{
      width:360px; max-width:96vw;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));
      border-radius:12px; padding:14px; box-shadow:0 12px 30px rgba(0,0,0,0.35);
    }
    header{display:flex;justify-content:space-between;align-items:center}
    header h1{margin:0;font-size:18px}
    .display{background:#071a2a;border-radius:10px;padding:12px;margin-top:12px;min-height:64px}
    #expr{font-size:18px;color:#cfeefd;word-break:break-all}
    #res{font-size:24px;color:var(--accent);font-weight:700;margin-top:6px}
    .controls{display:flex;gap:8px;margin-top:12px}
    .controls button{flex:1;padding:10px;border-radius:8px;border:none;background:var(--card);color:var(--text);cursor:pointer}
    .controls button.primary{background:linear-gradient(90deg,#0077cc,#00c6ff);color:#012032;font-weight:600}
    .keys{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
    .key{padding:12px;border-radius:8px;background:rgba(255,255,255,0.03);text-align:center;cursor:pointer;user-select:none}
    .key.op{background:linear-gradient(90deg,#003d66,#005f99);font-weight:600}
    .row{display:flex;gap:8px;margin-top:10px}
    .sci-panel{display:none;margin-top:12px;grid-template-columns:repeat(4,1fr);gap:8px}
    .small{font-size:12px;opacity:0.9}
    footer{margin-top:10px;font-size:12px;color:#cfeefd;text-align:center}
    /* light theme styles (toggle via body.light) */
    body.light{background:linear-gradient(135deg,#eaf4ff,#dff6ff);color:#062033}
    body.light .app{background:#fff;color:#062033}
    body.light .display{background:#fff;color:#062033}
    body.light .key{background:#f3f8ff;color:#062033}
    body.light .key.op{background:linear-gradient(90deg,#cfe9ff,#9fdfff);color:#062033}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Taobel Calculator">
    <header>
      <div>
        <h1>Taobel Calculator</h1>
        <div class="small">Standard / Scientific â€¢ Voice-enabled</div>
      </div>
      <div class="small">Taobel</div>
    </header>

    <div class="display" aria-live="polite">
      <div id="expr">0</div>
      <div id="res"></div>
    </div>

    <div class="controls">
      <button id="btnSpeak" class="primary">ðŸŽ¤ Speak</button>
      <button id="btnToggleSci">Scientific Mode</button>
      <button id="btnTTS">ðŸ”Š Read</button>
      <button id="btnClear">C</button>
    </div>

    <div class="keys" id="keys">
      <div class="key">7</div><div class="key">8</div><div class="key">9</div><div class="key op">/</div>
      <div class="key">4</div><div class="key">5</div><div class="key">6</div><div class="key op">*</div>
      <div class="key">1</div><div class="key">2</div><div class="key">3</div><div class="key op">-</div>
      <div class="key">0</div><div class="key">.</div><div class="key op">=</div><div class="key op">+</div>
    </div>

    <div class="sci-panel" id="sciPanel" aria-hidden="true">
      <div class="key op">sin(</div><div class="key op">cos(</div><div class="key op">tan(</div><div class="key op">log(</div>
      <div class="key op">ln(</div><div class="key op">sqrt(</div><div class="key op">^</div><div class="key op">Ï€</div>
      <div class="key op">e</div><div class="key op">xÂ²</div><div class="key op">xÂ³</div><div class="key op">%</div>
    </div>

    <footer>Offline â€¢ Blue theme â€¢ Taobel</footer>
  </div>

  <!-- Scripts placed at end so DOM exists before handlers attach -->
  <script>
  (function(){
    const exprEl = document.getElementById('expr');
    const resEl  = document.getElementById('res');
    const keysContainer = document.getElementById('keys');
    const sciPanel = document.getElementById('sciPanel');
    const btnSpeak = document.getElementById('btnSpeak');
    const btnToggleSci = document.getElementById('btnToggleSci');
    const btnTTS = document.getElementById('btnTTS');
    const btnClear = document.getElementById('btnClear');

    let expr = '';
    let lastAnswer = '';

    // Helpers
    function setExpr(v){ expr = v; exprEl.textContent = expr || '0'; updateResult(); }
    function appendToken(t){ if(expr==='0') expr = t; else expr += t; exprEl.textContent = expr; updateResult(); }
    function clearAll(){ expr=''; setExpr(''); resEl.textContent=''; lastAnswer=''; }

    // Safe evaluator
    function safeEval(s){
      if(!s || s.trim()==='') return null;
      try{
        // map math tokens
        let t = s.replace(/Ï€/g, String(Math.PI)).replace(/e/g, String(Math.E));
        t = t.replace(/sqrt\(/g, 'Math.sqrt(');
        t = t.replace(/\bln\(/g, 'Math.log(');                // natural log
        t = t.replace(/\blog\(/g, 'Math.log10(');             // log base 10
        t = t.replace(/\bsin\(/g, 'Math.sin(').replace(/\bcos\(/g,'Math.cos(').replace(/\btan\(/g,'Math.tan(');
        // xÂ², xÂ³ -> Math.pow handling when used like '3xÂ²' or '(... )xÂ²'
        t = t.replace(/(\d+|\))xÂ²/g, function(m){ return m.replace('xÂ²','**2'); });
        t = t.replace(/(\d+|\))xÂ³/g, function(m){ return m.replace('xÂ³','**3'); });
        // caret to exponent
        t = t.replace(/\^/g, '**');
        // percent: '50%' => (50/100)
        t = t.replace(/(\d+(\.\d+)?)%/g, '($1/100)');
        // remove any characters except allowed
        t = t.replace(/[^0-9+\-*/().,%Mathpinegslctanobxr**]/g,'');
        // evaluate with Function (safer than eval)
        const fn = new Function('return ('+t+')');
        const v = fn();
        if(typeof v === 'number' && isFinite(v)){
          // round small floating errors
          return Math.round((v + Number.EPSILON) * 1e12) / 1e12;
        }
        return null;
      }catch(e){
        return null;
      }
    }

    function updateResult(){
      const v = safeEval(expr);
      if(v !== null && v !== undefined){
        resEl.textContent = v;
        lastAnswer = String(v);
      } else {
        resEl.textContent = '';
      }
    }

    // Attach key handlers (works because DOM loaded)
    document.querySelectorAll('.key').forEach(k=>{
      k.addEventListener('click', ()=>{
        const txt = k.textContent.trim();
        if(txt === '='){
          const v = safeEval(expr);
          if(v !== null){ expr = String(v); exprEl.textContent = expr; resEl.textContent = v; lastAnswer = String(v); }
          return;
        }
        if(txt === 'C'){ clearAll(); return; }
        // allow ANS token insertion from future (not shown here)
        appendToken(txt);
      });
    });

    // Controls
    btnClear.addEventListener('click', clearAll);
    btnToggleSci.addEventListener('click', ()=>{
      if(sciPanel.style.display === 'grid'){ sciPanel.style.display = 'none'; btnToggleSci.textContent = 'Scientific Mode'; }
      else{ sciPanel.style.display = 'grid'; sciPanel.style.display = 'grid'; btnToggleSci.textContent = 'Standard Mode'; }
    });
    btnTTS.addEventListener('click', ()=>{
      const text = resEl.textContent || 'No result';
      try{ speechSynthesis.speak(new SpeechSynthesisUtterance('Result is ' + text)); }catch(e){}
    });

    // Voice recognition: normalize spoken words
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SpeechRec){
      const r = new SpeechRec();
      r.lang = 'en-US';
      r.interimResults = false;
      r.maxAlternatives = 1;
      r.addEventListener('result', (ev)=>{
        const spoken = ev.results[0][0].transcript.toLowerCase();
        // Map common words to tokens
        let mapped = spoken
          .replace(/plus/g,' + ')
          .replace(/minus/g,' - ')
          .replace(/times|multiplied by/g,' * ')
          .replace(/divided by|over/g,' / ')
          .replace(/point/g,'.')
          .replace(/pi/g,'Ï€')
          .replace(/square root of /g,'sqrt(')
          .replace(/square root /g,'sqrt(')
          .replace(/sine /g,'sin(').replace(/cosine /g,'cos(').replace(/tangent /g,'tan(')
          .replace(/power of /g,'^')
          .replace(/percent/g,'%')
          .replace(/to the power of /g,'^');
        // remove filler words (basic)
        mapped = mapped.replace(/(what is|calculate|equals|equal|please|the)/g,'');
        // trim
        mapped = mapped.trim();
        // close open parentheses smartly (if a function used without ) )
        const openFn = mapped.match(/(sin\(|cos\(|tan\(|sqrt\(|log\(|ln\()/g);
        if(openFn){ mapped = mapped + (mapped.includes('(') && !mapped.includes(')') ? ')' : ''); }
        expr = mapped;
        exprEl.textContent = expr || '0';
        updateResult();
      });
      btnSpeak.addEventListener('click', ()=>{ try{ r.start(); }catch(e){} });
    } else {
      btnSpeak.disabled = true;
      btnSpeak.textContent = 'ðŸŽ¤ not supported';
    }

    // register service worker for offline if available
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('service-worker.js').catch(()=>{ /* ignore */ });
    }

    // initial
    setExpr('');
  })();
  </script>
</body>
</html>
